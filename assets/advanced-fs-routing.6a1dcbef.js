var e=Object.defineProperty,a=Object.defineProperties,t=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(a,t,n)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[t]=n,s=(e,a)=>{for(var t in a||(a={}))i.call(a,t)&&r(e,t,a[t]);if(n)for(var t of n(a))l.call(a,t)&&r(e,t,a[t]);return e};import{c as o,L as p}from"./clientRender.715dbcf5.js";const d={};function g(e){var r,g=e,{components:c}=g,u=((e,a)=>{var t={};for(var r in e)i.call(e,r)&&a.indexOf(r)<0&&(t[r]=e[r]);if(null!=e&&n)for(var r of n(e))a.indexOf(r)<0&&l.call(e,r)&&(t[r]=e[r]);return t})(g,["components"]);return o("wrapper",(r=s(s({},d),u),a(r,t({components:c,mdxType:"MDXLayout"}))),o("h2",null,"Advanced Filesystem Routing: pageStrategy API"),o("blockquote",null,o("p",{parentName:"blockquote"},'The "Basic Filesystem Routing Convention" should satisfy most users\' needs. ',o("strong",{parentName:"p"},"You probably don't need to read this advanced guide"),".")),o("p",null,"For advanced users, vite-pages let you implement your own filesystem routing convention: you can ",o("strong",{parentName:"p"},"teach vite-pages how to collect page data from your project"),"."),o("p",null,"When ",o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/create-project/template-lib/vite.config.ts"}),"configuring vite-plugin-react-pages"),", you can pass the ",o("inlineCode",{parentName:"p"},"pageStrategy")," option. It should be an instance of ",o("inlineCode",{parentName:"p"},"PageStrategy")," class. Here is an example of customizing pageStrategy:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"// vite.config.ts\nimport { defineConfig } from 'vite'\nimport * as path from 'path'\nimport reactRefresh from '@vitejs/plugin-react-refresh'\nimport mdx from 'vite-plugin-mdx'\nimport pages, {\n  PageStrategy,\n  FileHandler,\n  File,\n  extractStaticData,\n} from 'vite-plugin-react-pages'\n\nexport default defineConfig({\n  plugins: [\n    reactRefresh(),\n    mdx(),\n    pages({\n      pagesDir: path.join(__dirname, 'pages'),\n      // custom pageStrategy\n      pageStrategy: new PageStrategy(function findPages(pagesDir, helpers) {\n        helpers.watchFiles(\n          pagesDir,\n          '**/index.{md,mdx,js,jsx,ts,tsx}',\n          fileHandler\n        )\n      }),\n    }),\n  ],\n})\n\nconst fileHandler: FileHandler = async (file: File, fileHandlerAPI) => {\n  const pagePublicPath = getPagePublicPath(file.relative)\n  fileHandlerAPI.addPageData({\n    pageId: pagePublicPath,\n    dataPath: file.path,\n    staticData: await extractStaticData(file),\n  })\n}\n\n/**\n * turn `sub-path/page2/index.tsx` into `/sub-path/page2`\n */\nfunction getPagePublicPath(relativePageFilePath: string) {\n  console.log('getPagePublicPath', relativePageFilePath)\n  let pagePublicPath = relativePageFilePath.replace(\n    /index\\.(md|mdx|js|jsx|ts|tsx)$/,\n    ''\n  )\n  // remove ending slash\n  pagePublicPath = pagePublicPath.replace(/\\/$/, '')\n  // add starting slash\n  pagePublicPath = `/${pagePublicPath}`\n  return pagePublicPath\n}\n")),o("p",null,"With this custom pageStrategy, page files don't need to ends with ",o("inlineCode",{parentName:"p"},"$"),". Instead, they need to match the pattern ",o("inlineCode",{parentName:"p"},"**/index.{md,mdx,js,jsx,ts,tsx}"),"."),o("blockquote",null,o("p",{parentName:"blockquote"},"Checkout complete examples in ",o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/playground/custom-find-pages2/vite.config.ts"}),"the custom-find-pages2 fixture")," or ",o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/create-project/template-lib/vite.config.ts"}),"the project scaffold"),".")),o("h3",null,"Steps of customizing pageStrategy"),o("p",null,"As shown by the above example, here is the usual steps to customize pageStrategy:"),o("ol",null,o("li",{parentName:"ol"},"Define a ",o("inlineCode",{parentName:"li"},"findPages")," function and pass it to ",o("inlineCode",{parentName:"li"},"PageStrategy")," constructor."),o("li",{parentName:"ol"},"Inside the ",o("inlineCode",{parentName:"li"},"findPages"),", use ",o("inlineCode",{parentName:"li"},"helpers.watchFiles(baseDir, glob, fileHandler)")," to find the files that you need.",o("ul",{parentName:"li"},o("li",{parentName:"ul"},"vite-pages will pass the glob(or glob array) to ",o("a",s({parentName:"li"},{href:"https://github.com/paulmillr/chokidar"}),"chokidar"),". vite-pages use chokidar to scan the fileSystem and watch for files."),o("li",{parentName:"ul"},"Whenever a file is scaned, added or updated, vite-pages will call the fileHandler with that file. When the file is unlinked, vite-pages will automatically delete the related page data."))),o("li",{parentName:"ol"},"Inside the ",o("inlineCode",{parentName:"li"},"fileHandler"),", read the infomation from ",o("inlineCode",{parentName:"li"},"file")," and register page data by calling ",o("inlineCode",{parentName:"li"},"fileHandlerAPI.addPageData"),".",o("ul",{parentName:"li"},o("li",{parentName:"ul"},"There are two more helpers inside ",o("inlineCode",{parentName:"li"},"fileHandlerAPI")," that help you to update page data. We will introduce them in the following section.")))),o("h3",null,"Handle file change and update page data"),o("p",null,"The ",o("inlineCode",{parentName:"p"},"fileHandler")," should conform to this interface:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"type FileHandler = (\n  file: File,\n  api: HandlerAPI\n) => void | Promise<void> | PageData | Promise<PageData>\n")),o("p",null,"The ",o("inlineCode",{parentName:"p"},"HandlerAPI")," contains a set of helpers that help you to update page data."),o("h4",null,"fileHandlerAPI.addPageData(pageData)"),o("p",null,"The pageData should conform to this interface:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"interface PageData {\n  /**\n   * The page route path.\n   * User can register multiple page data with same pageId,\n   * as long as they have different keys.\n   * Page data with same pageId will be merged.\n   *\n   * @example '/posts/hello-world'\n   */\n  readonly pageId: string\n  /**\n   * The data key.\n   * For a same page, users can register multiple data pieces,\n   * each with its own key. (Composed Page Data)\n   *\n   * @default 'main'\n   */\n  readonly key?: string\n  /**\n   * The path to the runtime data module.\n   * It will be registered with the `key`.\n   */\n  readonly dataPath?: string\n  /**\n   * The value of static data.\n   * It will be registered with the `key`.\n   */\n  readonly staticData?: any\n}\n")),o("p",null,"In most cases, ",o("inlineCode",{parentName:"p"},"dataPath")," is the path of the currently handled file. And ",o("inlineCode",{parentName:"p"},"staticData")," is statically extracted from the file content (js docblock or markdown frontmatter). Vite-pages has exported a helper ",o("inlineCode",{parentName:"p"},"extractStaticData")," to do that."),o("p",null,"Checkout ",o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/playground/custom-find-pages2/vite.config.ts"}),"the custom-find-pages2 fixture")," for an example."),o("blockquote",null,o("p",{parentName:"blockquote"},"Checkout ",o(p,{to:"/page-data",mdxType:"Link"},"the page data doc")," for more explanation of ",o("inlineCode",{parentName:"p"},"key"),".")),o("h4",null,"fileHandlerAPI.getRuntimeData(pageId)"),o("p",null,"Inside the fileHandler, you can use it to get the runtimeData of a certain page. You can read or mutate the properties of it:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"const runtimeDataPaths = fileHandlerAPI.getRuntimeData(pageId)\nif (!runtimeDataPaths[key]) runtimeDataPaths[key] = pathToRuntimeModule\n")),o("p",null,"Checkout ",o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/playground/custom-find-pages/vite.config.ts"}),"the custom-find-pages fixture")," for an example."),o("h4",null,"fileHandlerAPI.getStaticData(pageId)"),o("p",null,"Similar to the ",o("inlineCode",{parentName:"p"},"fileHandlerAPI.getRuntimeData")," API, you can use ",o("inlineCode",{parentName:"p"},"fileHandlerAPI.getStaticData")," to get the staticData of a certain page. And tou can read or mutate the properties of it:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"const staticData = fileHandlerAPI.getStaticData(pageId)\nif (!staticData[key]) staticData[key] = await extractStaticData(file)\n")),o("p",null,"Checkout ",o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/playground/custom-find-pages/vite.config.ts"}),"the custom-find-pages fixture")," for an example."),o("h3",null,"Sharable pageStrategy"),o("p",null,"You can also define your strategy as a subclass of ",o("inlineCode",{parentName:"p"},"PageStrategy"),". It is more sharable than the previous way."),o("p",null,"For example, this is how vite-pages defines the default page strategy:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"export class DefaultPageStrategy extends PageStrategy {\n  constructor(\n    opts: { extraFindPages?: FindPages; fileHandler?: FileHandler } = {}\n  ) {\n    const { extraFindPages, fileHandler = defaultFileHandler } = opts\n    // pass a wrapped findPages function to super class\n    super((pagesDir, helpersFromParent) => {\n      // we can create our own helpers, providing a default fileHandler\n      // and not using helpersFromParent\n      const helpers = this.createHelpers(fileHandler)\n      helpers.watchFiles(pagesDir, '**/*$.{md,mdx,js,jsx,ts,tsx}')\n      if (typeof extraFindPages === 'function') {\n        extraFindPages(pagesDir, helpers)\n      }\n    })\n  }\n}\n")),o("p",null,o("a",s({parentName:"p"},{href:"https://github.com/vitejs/vite-plugin-react-pages/blob/master/packages/react-pages/src/node/dynamic-modules/DefaultPageStrategy/index.ts"}),"Here is the complete definition of DefaultPageStrategy"),". And ",o(p,{to:"/examples/component-library",mdxType:"Link"},"here is an example of using it"),"."),o("h4",null,"Examples"),o("p",null,"For real-life examples of customizing pageStrategy, checkout ",o(p,{to:"/examples/component-library",mdxType:"Link"},'"Example: develop a component library"'),"."),o("h4",null,"Types"),o("p",null,"Here is the relavent types:"),o("pre",null,o("code",s({parentName:"pre"},{className:"language-ts"}),"type FindPages = (\n  pagesDir: string,\n  helpers: PageHelpers\n) => void | Promise<void>\n\ninterface PageHelpers extends HandlerAPI {\n  /**\n   * Read the static data from a file.\n   */\n  readonly extractStaticData: (file: File) => Promise<{\n    readonly [key: string]: any\n    readonly sourceType: string\n  }>\n  /**\n   * Scan the fileSystem and\n   * set page data in the file handler.\n   * File deletion will be handled automatically\n   */\n  readonly watchFiles: WatchFilesHelper\n}\n\ninterface WatchFilesHelper {\n  /** Watch all files within a directory (except node_modules and .git) */\n  (baseDir: string, fileHandler?: FileHandler): void\n  /** Watch files matching the given glob */\n  (baseDir: string, glob: string, fileHandler?: FileHandler): void\n  /** Watch files matching one of the given globs */\n  (baseDir: string, globs: string[], fileHandler?: FileHandler): void\n}\n\ntype FileHandler = (\n  file: File,\n  api: HandlerAPI\n) => void | Promise<void> | PageData | Promise<PageData>\n\ninterface HandlerAPI {\n  /**\n   * Get a mutable data object of runtimeData\n   */\n  getRuntimeData: (pageId: string) => {\n    [key: string]: string\n  }\n  /**\n   * Get a mutable data object of staticData\n   */\n  getStaticData: (pageId: string) => {\n    [key: string]: any\n  }\n  /**\n   * Add page data.\n   * If the data already exists, overwrite it.\n   */\n  addPageData: (pageData: PageData) => void\n}\n\ninterface PageData {\n  /**\n   * The page route path.\n   * User can register multiple page data with same pageId,\n   * as long as they have different keys.\n   * Page data with same pageId will be merged.\n   *\n   * @example '/posts/hello-world'\n   */\n  readonly pageId: string\n  /**\n   * The data key.\n   * For a same page, users can register multiple data pieces,\n   * each with its own key. (Composed Page Data)\n   *\n   * @default 'main'\n   */\n  readonly key?: string\n  /**\n   * The path to the runtime data module.\n   * It will be registered with the `key`.\n   */\n  readonly dataPath?: string\n  /**\n   * The value of static data.\n   * It will be registered with the `key`.\n   */\n  readonly staticData?: any\n}\n")))}g.isMDXComponent=!0;var c=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:g});const u={};u.main=c;export default u;
